<!DOCTYPE html>
<meta charset="utf-8">
<link href="default.css" rel="stylesheet" type="text/css">
<style>
  tr:nth-of-type(odd) {
    background: #eee;
  }
  tr.active {
    background: lightblue;
  }
  tr.hidden {
    display: none;
  }
</style>
<body>
Filter by community: <span id="mp-communities"></span>
<div id="mp-table"></div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!--script type="text/javascript" src="throughput-timeseries.js"></script>
<script type="text/javascript" src="long-polling.js"></script-->
<script>
    function strcmp(a,b) {
        a = a.toLowerCase();
        b = b.toLowerCase();
        return (a==b) ? 0 : ((a>b) ? 1 : -1);
    }
    d3.json('http://test-psui-vis.geant.org:9876/mplist/iperf3')
        .then(data => {

            titles = ['hostname', 'name', 'communities'];

            var table = d3.select('#mp-table').append('table');
            var rows = table.append('tbody').selectAll('tr')
                .data(data).enter()
                .append('tr')
                .on('mouseover', (d,i) => {
                    rows.filter( (d0, i0) => (i==i0) )
                        .classed('active', true);
                })
                .on('mouseout', (d,i) => {
                    rows.filter( (d0, i0) => (i==i0) )
                        .classed('active', false);
                });
            var headers = table.append('thead').append('tr')
                .selectAll('th')
                .data(titles).enter()
                .append('th')
                .text(d => d)
                .on('click', label => {
                    console.log(label);
                    rows.sort((a,b) => strcmp(a[label], b[label]));
                });
            rows.selectAll('td')
                .data(d => { return titles.map(k => {
                        return { 'value': d[k], 'name': k};
                    });
                }).enter()
                .append('td')
                .attr('data-th', d => d.name)
                .text(d => d.value);

            communities = [].concat.apply([], data.map(x => x.communities));
            communities = communities.filter(x => (x.length > 0));
            communities = Array.from(new Set(communities));
            communities.sort((a,b) => strcmp(a, b));
            communities.unshift('*ALL*')
            var select = d3.select('#mp-communities')
                .append('select')
                .on('change', () => {
                    s = d3.select('#mp-communities')
                            .select('select')
                            .property('value');
                    if (s == '*ALL*') {
                        rows.classed('hidden', false);
                    } else {
                        rows.filter(d => d.communities.includes(s))
                            .classed('hidden', false);
                        rows.filter(d => !d.communities.includes(s))
                            .classed('hidden', true);
                    }
                });
            select.selectAll('option')
                .data(communities).enter()
                .append('option')
                .text(String);

        });
</script>
